---
layout: post
title:  "服务网关 Gateway"
date:   2022-09-20 2:00:00 +0000
categories: jekyll update
---

# 服务网关

## 网关

网关一词最早出现在ip网络，用来代表数据报文需要离开一个广播域时应转发给的网络接口，例如：互联网上存在两个互联网络，网络A是10.1.1.0/24，网络B是192.168.0.0/24，在网络A内部，从10.1.1.10发送给10.1.1.20的报文是直接通信的，跟网关没有关系；但网络A的10.1.1.10发送给网络B的192.168.0.10时，报文会首先转发给网关接口10.1.1.1，查询路由表后走路由转发，经由网关192.168.1.1接口发送到网络B中。网关接口实体就是连接着两个网络的路由器上的物理接口或逻辑接口，这些网络接口配置的IP就是网关A的接口地址10.1.1.1和网关B的接口地址192.168.1.1。

网络上的网关主要负责隔离并连通两个不同的自治区域；管理和路由经过的数据信息。网络上网关所处的位置和代理是类似的，很多代理设备也承担网关的作用，比如企业办公网的VPN出口网关。从功能上区分的话，网关的功能要更复杂丰富一些，代理相对单一专精。


### 接入网关

最常见的网络网关设备就是接入网关AG（Access Gateway）了，接入网关位于网络的边缘接入层，一般在离用户物理位置较近的电信机房内，负责将普通用户接入到互联网或特种网络中。根据不同的通信媒介，接入网关可以分为：宽带接入网关BRAS，无线接入网关，DSL拨号接入网关，VPN接入网关，专线接入网关，有线电视接入网关等等，网关前更靠近用户侧的接入设备其作用是将用户的语音、传真、音视频和数据业务统一转换为接入网关支持的数据信号，例如IAD设备、常说的千兆猫、万兆猫、光猫、盒子等等。一个典型的场景是，用户通过在光猫上进行拨号设置后就可以连通互联网上网了，从接入网关BRAS的角度看，就是要将用户的光猫传入的用户名和密码交给连接BRAS的RADIUS认证设备（和用户数据库服务接口）进行认证，认证通过后，BRAS和光猫建立点对点连接，新配置并激活网关接口，开始转发用户连接互联网的数据报文，同时BRAS还会对该接口进行监控获取状态、时间、数据包流量等具体信息，进行管理和计量计费等。

接入网关很显著的特征就是增加了用户认证、监控功能，并且接入网关左右两个网络的通信协议大多数时候是不一样的，网关负责翻译。
## 服务网关 / API网关

服务网关借用了网络网关的概念，保留了网关关于区域隔离、路由、用户控制、安全、监控、协议转换等特征功能。在分布式应用、微服务应用兴起的当前市场下，服务网关成为不可缺失的一个重要设施/功能，增加了和服务相关的更多功能，例如负载均衡、服务容错、限流熔断、黑白名单、缓存、灰度发布、流量染色、文档中心、日志审计等。服务网关作为一组或多组服务的统一出口对外提供服务，将外部访问服务网关的各种流量，根据适当的规则路由到内部正确的服务实例上。服务网关的功能几乎涵盖了服务治理的大部分流量能力，事实上，业内有些宣称的完整微服务治理解决方案就是基于服务网关构建的（微服务治理方案的核心可以仅仅是某种RPC框架、某个注册中心产品、某API网关等），但服务网关从不忘初心上讲首先应该是个网关/路由器，具备路由流量的基础功能，然后才是其它扩展出来的能力，例如认证、安全、限流、监控等等，这些扩展能力通常是通过增加一层一层的过滤器实现的，好比是净水器的多重滤芯，在特定的过滤层分离出特征数据流量。

### 路由功能

服务网关可以路由访问流量的前提是可以识别这些流量，从哪个层面识别流量决定了服务网关的工作模式分类，根据报文中IP地址为特征进行路由的为四层网关，根据报文中HTTP的URL、头字节等为特征进行路由的为七层网关，根据更上层协议或特定字节为特征的为相应的网关，例如以安全为主要目的的安全网关/应用防火墙产品WAF，识别HTTP/HTTPs流量，感知用户、回话和应用本身，基于安全策略配置确保只被允许的请求操作才可以通过执行，并通过联网实时更新和抵御OWASP公布的最新漏洞攻击。

四层网关也叫`转发`网关，对于数据报文的识别路由多采用服务端直接返回给客户端的DSR三角传输模式，提高转发传输效率，避免统一网关成为性能瓶颈。DSR三角传输在我负载均衡的文章中详细介绍过；路由功能的实现在负载均衡器和服务网关本质上是一致的，但目的性上负载均衡是将数据流量智能的均分到多个服务后端上，而服务网关是将数据流量按照特征路由到特定的服务后端。负载均衡和服务网关的界限可以很模糊，产品化上可以是一体的，比如识别流量后根据流量特征路由到一个服务的多个服务后端，就是先路由后均衡的工作模式；业内有些服务网关本身就是基于原来的负载均衡器开发出来的，比如Kubernetes的Haproxy Ingress Controller实现基于负载均衡器Haproxy。

七层网关是`代理`网关，代理是表示终结/生成数据流量的节点动作，因为七层的服务网关在处理一次数据流量也就是HTTP中的请求时，会作为服务端对外部请求做应答response和作为客户端对内部服务做起请求request，是两个不同的传输层连接。

### 性能

每一次请求的处理过程都是七层网关的一次网络I/O处理，网络I/O的出入口是Socket的读写，写Socket就是等待远端服务发送的数据到达系统内核的特定缓冲区，读socket就是将数据从系统内核缓存区复制到应用程序对应进程的地址空间，根据读写socket工作时要不要等待、利用CPU的效率高不高、谁主导读写等，可分为五种I/O工作模型：

- 阻塞I/O模型，应用进程调用recvfrom进入内核态，一直等待数据写入内核缓冲区，然后复制到应用进程进入用户态的全过程；
- 非阻塞I/O模型，应用进程调用recvfrom会轮询数据是否写入内核缓冲区、是否准备好了，没准备好内核返回错误，应用进程就过一会儿再问；轮询中间的时候CPU的计算能力可以做别的工作；
- I/O复用模型，应用进程调用select或poll复用函数进入内核态同时监控多个I/O事件，不阻塞真正的系统调用而是阻塞select或poll。当多个I/O中的其中一个有数据写入内核缓冲区后，进程调用recvfrom进入内核态将数据复制到应用进程的缓冲器再进入用户态处理；
- 信号驱动模型，应用进程调用sigaction进入内核态执行后返回，内核中的数据准备好了之后会发给用户态的应用进程一个SIGIO信号，应用进程然后调用recvfrom进入内核态将数据复制到应用进程的缓冲器再进入用户态处理；
- 异步I/O模型，应用进程调用异步函数aio_read进入内核态返回，告知内核自己读写缓冲区的位置以及通知自己的方式。内核接管后面所有的过程，包括把数据复制到应用进程的缓冲器，并通知应用进程可以处理数据了。异步的意思是应用程序用户态返回时，并不是完成就绪状态，还需要等内核态的信号通知。

服务网关的性能优劣取决于很多因素，实际环境下应该通过测试获取真实数据然后与生产预期进行比较。举个例子：如果一个服务网关管理的应用多是计算密集型应用，例如需要进行复杂运算、查找特征数据之类的应用，一旦占用CPU后耗时比较长，则采用阻塞I/O模型可以节约一些过多的信号控制和交互使用的CPU资源；如果服务网关管理的应用多是I/O密集型应用，例如请求网页、读写文件和数据库之类的，则使用异步I/O模型性能会更好，因为减少了线程数，性能就会上去，延迟也会降低。
### 可用性

服务网关是用户访问一系列服务的入口，其重要性不言而喻，生产环境下服务网关的高可用性可以通过在多个服务网关设备的前面部署负载均衡器来实现，或者在导向服务网关的路由设备上配置静态路由/动态路由协议支持的等价多路径ECMP功能，以实现多路径负载均衡和链路备份。

使用经过市场验证的成熟的网关产品也可以增加可用性，例如Nginx ingress controller, Kong, Zull 2.0, Spring Cloud Gateway，Traefik, Envoy（除了边车代理，envoy的另一个工作模式就是服务网关），多数网关可配置I/O工作模型，以适配不同类型服务的管理。
## 一大波网关

### VPN网关

通常也叫VPN网关路由器，位于网络接入层，部署在企业接入互联网的位置，主要目的是实现不同的网络互联就像一个内部网络一样，典型使用的场景是企业总部和分支机构网络互联。VPN网关一般内置防火墙，可以防护ARP攻击，端口扫描等，支持静态路由，VLAN，IPsec，ARP防伪，QoS，ACL，NAT，DHCP, NTP等相关功能，接入使用的网络层协议是PPP或者PPPoE等，使用拨号进行点点、点面或面面的网络连接。

### NAT网关

NAT网关能够为位于私有网络内例如企业内部、IDC中心内，或私有云内的主机提供网络地址的转换服务，最终实现多个主机/云主机可以共享公网IP访问Internet的功能（SNAT源地址转换），或者使用户可以通过互联网访问私网内的这些云主服务（DNAT目的地址转换）。NAT网关一般做为一个软件功能内嵌于VPN网关路由其中，和VPN以及其它功能一起实现云上网络和云下私网或专线网络的互访。
### 物联网网关

物联网网关是特殊的一种接入网关，主要功能是数据接收、协议转换、通信管理、数据处理转发流程中的协议转换，家庭中的物联网网关将智能家居使用的WiFi、BLEmesh、ZigBee等通信协议翻译并接入到互联网（WiFi其实不额外需要专用网关设备，接入速度高能耗大，适合插电的智能家具），而工业中的物联网关则主要应用在环境监测、工厂机器设备或生产线的环境中处理传感器传入的数据/信号信息，基于互联网构建智能传感网络，工业设备例如工控机、可编程逻辑控制器PLC的接口主要有RJ45、RS232、RS485等，协议是专用的Modbus、ProfiBus、OPC UA和BACnet等。除了协议转换外，物联网网关还有一些基于物联网领域特征的功能，例如灵活的插件机制，零配置组网启动的设备的配置信息存储，设备管理和空中升级，身份认证，加解密，VPN接入等。

### 边缘计算网关

边缘计算网关也被称为物联网网边缘计算网关，它可以在设备上运行本地计算、消息通信、数据缓存等功能的智能网关，可以在无需联网的情况实现设备的本地联动以及实时、短周期的数据处理分析，最大的特点是有一定的自治计算分析能力并且低延迟、低成本等，边缘计算网关是云计算能力在用户端的复制扩展和补充，称为云边协同。边缘计算网关的应用场景适用于大量设备需要接入、云端需要向网络侧转移的场景，例如：智慧园区的安防监控、视频分析、电梯、路灯、红外灯，智慧农业的环境数据监测监控、实时图像监控、自动浇水杀虫，智能电网的智慧充电桩、配电自动化、智能电网高、提高能效，智慧工业中的大数据分析、深度学习、AI，自动驾驶，无人机，工业机器人等。边缘计算网关中的各类业务应用通常是通过容器模式部署到边缘的，不定期的可以从云中心获取新版本进行功能迭代。
### 网关协议

网关协议的说法最早是计算机网络中提出来的，位于网络的IP路由层，常见的网关协议有一个自治域内路由器共享路由信息使用的内部网关协议RIP，OSPF和不同自治域之间交换路由信息的外部网关协议BGP。这个网关协议和大多数现在流行的xxx网关的说法是没有关系的。

### 云原生网关

云原生网关是在云原生环境中开发出的网关产品，可以支撑和适应更多的服务场景，性能和稳定性也更好。除了传统服务网关/API网关提供的请求代理、熔断限流、负载均衡、路由、用户控制、监控等功能外，云原生网关对云原生环境更友好，架构轻巧，通常都是容器化结构，组件高内聚松耦合，网关节点本身无状态，可以随意扩容缩容。网关功能插件化，新增功能即时生效。传统的API网关代表有Nginx, Zuul, SpringCloud Gateway等；云原生网关代表有Kong, Envoy, APISIX等。

### web应用安全网关/web应用防火墙WAF

WAF保护Web服务应用免受各类应用层的攻击，例如跨站点脚本XSS、SQL注入、ookie中毒。WAF具备可升级可扩展性，针对业内发现并公布的安全漏洞及时配置更新，有效拦截一系列企图通过入侵应用系统来泄露重要数据的攻击。WAF部署于用户和应用之间，作为中介和网关会提前对往来于两者之前的通信进行应用层上HTTP/HTTPS请求的各种分析，感知用户、会话和应用，了解其背后的Web应用及其提供的服务。WAF确保仅执行基于安全策略配置所允许的操作，并抵御OWASP公布的最常见应用漏洞，这些知名的漏洞目前包括：
- 注入攻击
- 破解认证
- 敏感数据暴露
- XML外部实体XXE
- 失效的访问控制
- 安全配置错误
- 跨站点脚本XSS
- 不安全的反序列化


### 数据安全网关

用户请求大数据平台、数据中台或者数据仓库时经过数据安全网关，可以实现分类数据细颗粒度的访问控制，统一审计，数据动态脱敏等专业安全访问控制。与数据安全网关类似的说法还有，数据网关，但有些场景下，数据网关也指物联网网关或边缘计算网关。

### 数据库网关

数据库网关主要实现内网数据库和公网数据库，以及不同自治域之间数据库的迁移，实现数据一键上云、数据库备份等功能。

### 存储网关/云存储网关

云存储网关为企业上云或云上的企业提供存储协议的转换服务，提供给用户的存储方式是比较简单易用的文件存储（NAS、NFS、FTP、SMB）或块存储模式（iSCSI），实际后端通常是公有云的对象存储，用户不用担心数据存储架构的安全性和可靠性。存储网关支持本地存储缓存以提高性能，支持数据的加密、压缩、版本控制、快照等高阶存储功能。

### 媒体网关
媒体网关是一个老说法了，早期模拟电话发展到数字电话时媒体网关的叫法就有了。媒体网关的主要作用也是协议转换和翻译，例如PSTN网络接入，IP网络和ATM网络，移动网络和语音程控交换机网络PBX，媒体网关内使用不同的通信协议在异构网络中传递信号和数据。

### 更多的xxx网关...
